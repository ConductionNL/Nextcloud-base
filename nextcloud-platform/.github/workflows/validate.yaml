---
# CI/CD Pipeline for Nextcloud Platform
# Runs on all PRs and pushes to main
#
# Checks:
# 1. YAML lint
# 2. Kubernetes schema validation
# 3. Helm lint and template
# 4. Policy checks (kube-score, conftest)
# 5. Secret scanning (gitleaks)
# 6. Custom value validation

name: Validate

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "values/**"
      - "platform/**"
      - "argo/**"
      - "scripts/**"
      - ".github/workflows/**"
  pull_request:
    branches:
      - main
      - develop

env:
  HELM_VERSION: "3.14.0"
  KUBECONFORM_VERSION: "0.6.4"
  KUBE_SCORE_VERSION: "1.17.0"

jobs:
  # Job 1: YAML Lint
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Create yamllint config
        run: |
          cat > .yamllint.yaml << 'EOF'
          extends: relaxed
          rules:
            line-length:
              max: 200
              level: warning
            truthy:
              check-keys: false
            comments:
              min-spaces-from-content: 1
            document-start: disable
          EOF

      - name: Run yamllint
        run: |
          yamllint -c .yamllint.yaml \
            values/ \
            argo/ \
            platform/

  # Job 2: Kubernetes Schema Validation
  kubeconform:
    name: Kubernetes Schema Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kubeconform
        run: |
          wget -q https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz
          tar xzf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Argo CD manifests
        run: |
          kubeconform -strict \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -ignore-missing-schemas \
            -summary \
            argo/

      - name: Validate Platform manifests
        run: |
          find platform/ -name "*.yaml" -type f ! -name "kustomization.yaml" ! -name "values.yaml" ! -name "_*.tpl" | \
          xargs -I {} kubeconform -strict \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -ignore-missing-schemas \
            {}

  # Job 3: Helm Lint and Template
  helm-checks:
    name: Helm Lint & Template
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v${{ env.HELM_VERSION }}

      - name: Add Nextcloud Helm repo
        run: |
          helm repo add nextcloud https://nextcloud.github.io/helm/
          helm repo update

      - name: Install yq
        run: |
          sudo wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Helm lint with common values
        run: |
          # Lint doesn't work directly with remote charts
          # Instead, validate our values files are valid YAML
          for file in values/common.yaml values/env/*.yaml; do
            echo "Checking: $file"
            yq eval '.' "$file" > /dev/null
          done

      - name: Template canary tenant
        run: |
          helm template nextcloud nextcloud/nextcloud \
            --values values/common.yaml \
            --values values/env/prod.yaml \
            --values values/tenants/tenant-canary.yaml \
            --namespace nc-canary \
            --set fullnameOverride=nextcloud \
            > /tmp/canary-manifests.yaml
          
          echo "Generated $(wc -l < /tmp/canary-manifests.yaml) lines"
          
          # Verify key resources exist
          grep -q "kind: Deployment" /tmp/canary-manifests.yaml
          grep -q "kind: Service" /tmp/canary-manifests.yaml
          grep -q "kind: Ingress" /tmp/canary-manifests.yaml
          
          echo "✓ All expected resources found for canary"

      - name: Template example tenant
        run: |
          helm template nextcloud nextcloud/nextcloud \
            --values values/common.yaml \
            --values values/env/prod.yaml \
            --values values/tenants/tenant-example.yaml \
            --namespace nc-example \
            --set fullnameOverride=nextcloud \
            > /tmp/example-manifests.yaml
          
          echo "Generated $(wc -l < /tmp/example-manifests.yaml) lines"
          
          # Verify key resources exist
          grep -q "kind: Deployment" /tmp/example-manifests.yaml
          grep -q "kind: Service" /tmp/example-manifests.yaml
          
          echo "✓ All expected resources found for example"

      - name: Validate generated manifests with kubeconform
        run: |
          wget -q https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz
          tar xzf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/
          
          for manifest in /tmp/*-manifests.yaml; do
            echo "Validating: $manifest"
            kubeconform -strict \
              -schema-location default \
              -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
              -ignore-missing-schemas \
              -summary \
              "$manifest"
          done

  # Job 4: Policy Checks
  policy-checks:
    name: Policy Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: v${{ env.HELM_VERSION }}

      - name: Add Nextcloud Helm repo
        run: |
          helm repo add nextcloud https://nextcloud.github.io/helm/
          helm repo update

      - name: Install kube-score
        run: |
          wget -q https://github.com/zegl/kube-score/releases/download/v${KUBE_SCORE_VERSION}/kube-score_${KUBE_SCORE_VERSION}_linux_amd64.tar.gz
          tar xzf kube-score_${KUBE_SCORE_VERSION}_linux_amd64.tar.gz
          sudo mv kube-score /usr/local/bin/

      - name: Generate manifests for policy check
        run: |
          helm template nextcloud nextcloud/nextcloud \
            --values values/common.yaml \
            --values values/env/prod.yaml \
            --values values/tenants/tenant-canary.yaml \
            --namespace nc-canary \
            --set fullnameOverride=nextcloud \
            > /tmp/manifests.yaml

      - name: Run kube-score
        run: |
          # Run kube-score with reasonable threshold
          # Some checks may not apply to Nextcloud's specific needs
          kube-score score /tmp/manifests.yaml \
            --ignore-test pod-networkpolicy \
            --ignore-test container-security-context-readonlyrootfilesystem \
            --ignore-test deployment-has-poddisruptionbudget \
            --output-format ci || true
          
          echo ""
          echo "Note: Some kube-score warnings may be acceptable for Nextcloud"

      - name: Install conftest
        run: |
          wget -q https://github.com/open-policy-agent/conftest/releases/download/v0.48.0/conftest_0.48.0_Linux_x86_64.tar.gz
          tar xzf conftest_0.48.0_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/

      - name: Create OPA policies
        run: |
          mkdir -p policy
          cat > policy/nextcloud.rego << 'EOF'
          package main
          
          # Deny if no resource limits are set
          deny[msg] {
            input.kind == "Deployment"
            container := input.spec.template.spec.containers[_]
            not container.resources.limits
            msg := sprintf("Container %s in Deployment %s has no resource limits", [container.name, input.metadata.name])
          }
          
          # Warn if using latest tag
          warn[msg] {
            input.kind == "Deployment"
            container := input.spec.template.spec.containers[_]
            endswith(container.image, ":latest")
            msg := sprintf("Container %s uses :latest tag", [container.name])
          }
          
          # Deny privileged containers
          deny[msg] {
            input.kind == "Deployment"
            container := input.spec.template.spec.containers[_]
            container.securityContext.privileged == true
            msg := sprintf("Container %s is privileged", [container.name])
          }
          
          # Warn if no readiness probe
          warn[msg] {
            input.kind == "Deployment"
            container := input.spec.template.spec.containers[_]
            not container.readinessProbe
            msg := sprintf("Container %s has no readiness probe", [container.name])
          }
          EOF

      - name: Run conftest
        run: |
          conftest test /tmp/manifests.yaml --policy policy/ || true

  # Job 5: Secret Scanning
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Additional secret patterns check
        run: |
          echo "Checking for hardcoded secrets..."
          
          # Patterns to check
          patterns=(
            "password\s*[:=]\s*['\"][^${}]"
            "secret\s*[:=]\s*['\"][^${}]"
            "apikey\s*[:=]\s*['\"][^${}]"
            "api_key\s*[:=]\s*['\"][^${}]"
            "access_key\s*[:=]\s*['\"][^${}]"
            "-----BEGIN.*PRIVATE KEY-----"
          )
          
          found=0
          for pattern in "${patterns[@]}"; do
            if grep -riE "$pattern" values/ --include="*.yaml" 2>/dev/null | grep -v "secretKeyRef" | grep -v "existingSecret"; then
              echo "⚠️  Potential secret found matching: $pattern"
              found=1
            fi
          done
          
          if [ $found -eq 1 ]; then
            echo ""
            echo "⚠️  Potential secrets detected. Please review above matches."
            echo "If these are false positives (e.g., references to secrets), this is OK."
          else
            echo "✓ No hardcoded secrets detected"
          fi

  # Job 6: Values Validation
  values-validation:
    name: Values Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Install yamllint
        run: pip install yamllint

      - name: Run values validation script
        run: |
          chmod +x scripts/validate-values.sh
          ./scripts/validate-values.sh

  # Job 7: Kustomize Build Test
  kustomize-build:
    name: Kustomize Build Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Build platform components
        run: |
          for component in redis pgbouncer externalsecrets policies; do
            dir="platform/$component"
            if [ -f "$dir/kustomization.yaml" ]; then
              echo "Building: $component"
              kubectl kustomize "$dir" > /tmp/${component}.yaml
              echo "✓ $component built successfully ($(wc -l < /tmp/${component}.yaml) lines)"
            fi
          done

      - name: Validate kustomize output
        run: |
          wget -q https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz
          tar xzf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/
          
          for manifest in /tmp/*.yaml; do
            if [ -f "$manifest" ]; then
              echo "Validating: $(basename $manifest)"
              kubeconform -strict \
                -schema-location default \
                -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
                -ignore-missing-schemas \
                "$manifest" || true
            fi
          done

  # Summary job
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      - yaml-lint
      - kubeconform
      - helm-checks
      - policy-checks
      - secret-scan
      - values-validation
      - kustomize-build
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## CI Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Lint | ${{ needs.yaml-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kubeconform | ${{ needs.kubeconform.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Helm Checks | ${{ needs.helm-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Policy Checks | ${{ needs.policy-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Values Validation | ${{ needs.values-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kustomize Build | ${{ needs.kustomize-build.result }} |" >> $GITHUB_STEP_SUMMARY
          
          # Fail if any required job failed
          if [ "${{ needs.yaml-lint.result }}" == "failure" ] || \
             [ "${{ needs.helm-checks.result }}" == "failure" ] || \
             [ "${{ needs.secret-scan.result }}" == "failure" ] || \
             [ "${{ needs.values-validation.result }}" == "failure" ]; then
            echo ""
            echo "❌ One or more critical checks failed!"
            exit 1
          fi
          
          echo ""
          echo "✅ All critical checks passed!"

