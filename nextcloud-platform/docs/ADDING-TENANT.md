# Adding a New Tenant

This guide explains how to add a new Nextcloud tenant to the platform.

## Prerequisites

Before adding a tenant, ensure:

1. **S3 Bucket Created**: Create the S3 bucket in Ceph RGW
2. **Database Created**: Create the PostgreSQL database
3. **DNS Configured**: Set up DNS for the tenant hostname
4. **Secrets Stored**: Add secrets to Vault (if using ESO)

## Step 1: Create S3 Bucket

Create the bucket in Ceph RGW:

```bash
# Using s3cmd
s3cmd mb s3://nextcloud-newtenant-prod

# Or using AWS CLI with Ceph endpoint
aws --endpoint-url https://s3.prod.example.com s3 mb s3://nextcloud-newtenant-prod
```

Create S3 credentials:

```bash
# Using radosgw-admin
radosgw-admin user create --uid=nextcloud-newtenant --display-name="Nextcloud New Tenant"
radosgw-admin key create --uid=nextcloud-newtenant --key-type=s3 --gen-access-key --gen-secret
```

## Step 2: Create PostgreSQL Database

Connect to PostgreSQL and create the database:

```sql
-- Create database
CREATE DATABASE nextcloud_newtenant;

-- Create user (or use existing nextcloud user)
CREATE USER nextcloud_newtenant WITH ENCRYPTED PASSWORD 'secure-password';

-- Grant privileges
GRANT ALL PRIVILEGES ON DATABASE nextcloud_newtenant TO nextcloud_newtenant;

-- Connect to database and grant schema permissions
\c nextcloud_newtenant
GRANT ALL ON SCHEMA public TO nextcloud_newtenant;
```

## Step 3: Store Secrets

### Option A: Vault (Recommended)

```bash
vault kv put secret/nextcloud/prod/newtenant \
  admin-password="$(openssl rand -base64 24)" \
  s3-access-key="ACCESS_KEY_FROM_STEP_1" \
  s3-secret-key="SECRET_KEY_FROM_STEP_1" \
  db-password="secure-password" \
  redis-password="" \
  nextcloud-secret="$(openssl rand -base64 48)"
```

### Option B: Manual (Fallback)

Secrets will be generated by the Job, but you'll need to update S3 and DB credentials manually after deployment.

## Step 4: Configure DNS

Add DNS record for the tenant hostname:

```
newtenant.nextcloud.example.com  A/CNAME  <ingress-ip-or-cname>
```

If using a custom domain:

```
cloud.newtenant-company.com  CNAME  newtenant.nextcloud.example.com
```

## Step 5: Create Tenant Values File

Create `values/tenants/tenant-newtenant.yaml`:

```yaml
---
# New Tenant Configuration
tenant:
  name: newtenant
  environment: prod
  wave: 2  # Production wave (after canary and wave 1)
  hostname: newtenant.nextcloud.example.com
  
  s3:
    bucket: nextcloud-newtenant-prod
    prefix: ""
  
  # Optional: custom domain
  # customDomain: cloud.newtenant-company.com

# Nextcloud settings
nextcloud:
  host: newtenant.nextcloud.example.com
  
  trustedDomains:
    - newtenant.nextcloud.example.com
    # - cloud.newtenant-company.com  # Uncomment if using custom domain
  
  # S3 Primary Storage Configuration
  configs:
    s3.config.php: |
      <?php
      $CONFIG = array (
        'objectstore' => array(
          'class' => '\OC\Files\ObjectStore\S3',
          'arguments' => array(
            'bucket' => 'nextcloud-newtenant-prod',
            'hostname' => 's3.prod.example.com',
            'port' => 443,
            'use_ssl' => true,
            'verify_ssl_cert' => true,
            'region' => '',
            'use_path_style' => true,
            'key' => getenv('S3_ACCESS_KEY'),
            'secret' => getenv('S3_SECRET_KEY'),
            'objectPrefix' => 'urn:oid:',
            'autocreate' => false,
          ),
        ),
      );

# Ingress
ingress:
  tls:
    - secretName: nextcloud-newtenant-tls
      hosts:
        - newtenant.nextcloud.example.com
        # - cloud.newtenant-company.com  # Uncomment if using custom domain
  hosts:
    - host: newtenant.nextcloud.example.com
      paths:
        - path: /
          pathType: Prefix
    # Uncomment for custom domain:
    # - host: cloud.newtenant-company.com
    #   paths:
    #     - path: /
    #       pathType: Prefix

# Database
externalDatabase:
  database: nextcloud_newtenant

# Resources (optional - uses prod defaults)
# resources:
#   requests:
#     cpu: 500m
#     memory: 1Gi
#   limits:
#     cpu: 4
#     memory: 4Gi

# S3 credentials as environment variables
extraEnv:
  - name: PHP_MEMORY_LIMIT
    value: "2048M"
  - name: PHP_UPLOAD_LIMIT
    value: "16G"
  - name: S3_ACCESS_KEY
    valueFrom:
      secretKeyRef:
        name: nextcloud-secrets
        key: s3-access-key
  - name: S3_SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: nextcloud-secrets
        key: s3-secret-key

# Labels
podLabels:
  nextcloud.platform/tenant: newtenant
  nextcloud.platform/wave: "2"
```

## Step 6: Validate Configuration

Run validation scripts:

```bash
# Validate tenant file
./scripts/validate-values.sh values/tenants/tenant-newtenant.yaml

# Run smoke checks
./scripts/smoke-checks.sh --tenant newtenant
```

## Step 7: Commit and Push

```bash
git add values/tenants/tenant-newtenant.yaml
git commit -m "feat: add newtenant to Nextcloud platform"
git push origin main
```

## Step 8: Monitor Deployment

Argo CD will automatically create the Application:

```bash
# Watch Application creation
kubectl get application -n argocd -w

# Check sync status
argocd app get nc-newtenant

# Check pods
kubectl get pods -n nc-newtenant
```

## Step 9: Update Secrets (If Using Fallback)

If not using ESO, update the placeholder secrets:

```bash
# Get generated admin password (save this!)
kubectl logs -n nc-newtenant job/nextcloud-secret-generator | grep "admin password"

# Update S3 and DB credentials
kubectl patch secret nextcloud-secrets -n nc-newtenant \
  --type='json' \
  -p='[
    {"op": "replace", "path": "/data/s3-access-key", "value": "'$(echo -n "REAL_ACCESS_KEY" | base64)'"},
    {"op": "replace", "path": "/data/s3-secret-key", "value": "'$(echo -n "REAL_SECRET_KEY" | base64)'"},
    {"op": "replace", "path": "/data/db-password", "value": "'$(echo -n "REAL_DB_PASSWORD" | base64)'"}
  ]'

# Restart to pick up new credentials
kubectl rollout restart deployment -n nc-newtenant nextcloud
```

## Step 10: Verify Deployment

```bash
# Check Nextcloud status
kubectl exec -it -n nc-newtenant deploy/nextcloud -- php occ status

# Check S3 connectivity
kubectl exec -it -n nc-newtenant deploy/nextcloud -- php occ files:scan --dry-run admin

# Access web UI
open https://newtenant.nextcloud.example.com
```

## Step 11: Initial Setup

1. Log in with admin credentials
2. Configure apps
3. Create users
4. Set up external storage (if needed)
5. Configure mail settings (if needed)

## Troubleshooting

### Application Not Created

Check ApplicationSet:

```bash
kubectl get applicationset nextcloud-tenants -n argocd -o yaml
kubectl logs -n argocd deploy/argocd-applicationset-controller
```

### Sync Failed

```bash
argocd app get nc-newtenant
argocd app sync nc-newtenant --prune
```

### S3 Errors

```bash
# Check S3 config
kubectl exec -it -n nc-newtenant deploy/nextcloud -- cat /var/www/html/config/s3.config.php

# Check environment variables
kubectl exec -it -n nc-newtenant deploy/nextcloud -- env | grep S3
```

### Database Errors

```bash
# Check database connectivity
kubectl exec -it -n nc-newtenant deploy/nextcloud -- php occ db:add-missing-indices --dry-run

# Check PgBouncer logs
kubectl logs -n nextcloud-platform deploy/pgbouncer
```

## Removing a Tenant

To remove a tenant:

1. Backup data and database
2. Delete the tenant file:
   ```bash
   git rm values/tenants/tenant-newtenant.yaml
   git commit -m "chore: remove newtenant"
   git push
   ```
3. Argo CD will delete the Application and namespace
4. Clean up S3 bucket and database manually

