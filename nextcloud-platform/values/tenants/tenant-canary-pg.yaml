---
# =============================================================================
# POSTGRESQL TENANT TEMPLATE - Copy to values/tenants/tenant-<name>.yaml
# =============================================================================
# This file is NOT deployed, it's just a template!
#
# VERSCHIL met tenant-template.yaml:
#   - PostgreSQL i.p.v. MariaDB
#   - Custom PostgreSQL image met extensions
#   - Per-tenant Redis (later: platform Redis)
#
# STAPPEN:
#   1. Kopieer naar: values/tenants/tenant-<jouw-naam>.yaml
#   2. Vervang overal:
#      - canary-pg  ->  tenant identifier (bijv. "acme")
#      - nextcloud-canary-pg.commonground.nu     ->  volledige hostname (bijv. "acme.nextcloud.commonground.nu")
#      - nextcloud_canary_pg->  database naam (bijv. "nextcloud_acme")
#   3. Pas environment aan: "prod" of "accept"
#   4. Maak secret aan: ./scripts/create-tenant-secret.sh canary-pg --postgres
#   5. Commit & push - ArgoCD pikt de nieuwe tenant automatisch op
#
# =============================================================================

tenant:
  name: canary-pg
  environment: prod                    # "accept" of "prod"
  wave: "1"                            # 0=canary (eerst), 1+=productie waves
  hostname: nextcloud-canary-pg.commonground.nu
  
  s3:
    bucket: nextcloud
    prefix: "canary-pg/"         # Isolatie per tenant in shared bucket

# =============================================================================
# DATABASE: PostgreSQL (in-cluster, per tenant)
# =============================================================================
# Custom image met extensions voor betere performance
# =============================================================================

# Disable MariaDB
mariadb:
  enabled: false

# Enable PostgreSQL
postgresql:
  enabled: true
  image:
    registry: ghcr.io
    repository: conductionnl/nextcloud-images
    tag: postgres16-ext-sha-6b56bfeda88356d768179c7b2220fb9ded1b4adf
    pullPolicy: Always
  auth:
    database: nextcloud_canary_pg
    username: nextcloud
    existingSecret: nextcloud-secrets
    secretKeys:
      adminPasswordKey: postgres-password
      userPasswordKey: db-password
  primary:
    persistence:
      enabled: true
      size: 8Gi
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi

# Disable alternatives
internalDatabase:
  enabled: false

externalDatabase:
  enabled: false

# =============================================================================
# REDIS: Per-tenant (standalone)
# =============================================================================
# Later: migreren naar platform Redis
# =============================================================================

redis:
  enabled: true
  auth:
    enabled: true
    existingSecret: nextcloud-secrets
    existingSecretPasswordKey: redis-password
  image:
    repository: bitnamilegacy/redis
    tag: "7.2"
  master:
    persistence:
      enabled: true
      size: 2Gi
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 256Mi
  replica:
    replicaCount: 0  # Single node for now

# =============================================================================
# NEXTCLOUD SETTINGS
# =============================================================================
nextcloud:
  host: nextcloud-canary-pg.commonground.nu
  
  trustedDomains:
    - nextcloud-canary-pg.commonground.nu
  
  # Override redis config for per-tenant Redis
  # Note: common.yaml has platform Redis, this overrides it
  configs:
    tenant.config.php: |
      <?php
      $CONFIG = array (
        // Required for WebDAV self-check
        'overwrite.cli.url' => 'https://nextcloud-canary-pg.commonground.nu',
      );
    
    # Override redis config for per-tenant Redis
    redis.config.php: |
      <?php
      $CONFIG = array (
        'memcache.local' => '\\OC\\Memcache\\APCu',
        'memcache.distributed' => '\\OC\\Memcache\\Redis',
        'memcache.locking' => '\\OC\\Memcache\\Redis',
        'redis' => array(
          'host' => 'nextcloud-redis-master',
          'port' => 6379,
          'timeout' => 1.5,
          'password' => getenv('REDIS_HOST_PASSWORD'),
        ),
        'filelocking.enabled' => true,
      );
  
  # Pod security context - www-data is UID/GID 33 in official Nextcloud image
  podSecurityContext:
    fsGroup: 33
    fsGroupChangePolicy: "OnRootMismatch"

  # ===========================================================================
  # ENVIRONMENT VARIABLES
  # ===========================================================================
  extraEnv:
    - name: PHP_MEMORY_LIMIT
      value: "2048M"
    - name: PHP_UPLOAD_LIMIT
      value: "16G"
    # S3 credentials (uit secret)
    - name: S3_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: nextcloud-secrets
          key: s3-access-key
    - name: S3_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: nextcloud-secrets
          key: s3-secret-key
    # NOTE: REDIS_HOST_PASSWORD is automatically added by Helm chart when redis.enabled=true
    # -------------------------------------------------------------------------
    # APP VERSION PINNING (optioneel)
    # -------------------------------------------------------------------------
    # Uncomment om specifieke versies te pinnen.
    # Als niet gezet → latest uit app store.
    #
    # Format: versie ZONDER 'v' prefix
    #   Stable:  "1.2.3"
    #   Beta:    "0.2.10-beta.9"
    #
    # - name: OPENCATALOGI_VERSION
    #   value: "0.7.6"
    # - name: OPENCONNECTOR_VERSION
    #   value: "0.2.6"
    # - name: OPENREGISTER_VERSION
    #   value: "0.2.8"

  # ===========================================================================
  # CONDUCTION APPS INSTALLER (hooks)
  # ===========================================================================
  # Installeert automatisch de Conduction product apps bij NIEUWE installatie:
  #   - opencatalogi   : Open Catalogi - publicatie platform
  #   - openconnector  : Open Connector - integratie platform
  #   - openregister   : Open Register - register beheer
  #
  # Versie gedrag:
  #   - Geen *_VERSION env var → latest uit app store
  #   - Met *_VERSION env var  → specifieke versie van GitHub releases
  #
  # Logs: /var/www/html/data/conduction-apps.log
  # Ref: https://github.com/nextcloud/docker#auto-configuration-via-hook-folders
  # ===========================================================================
  hooks:
    post-installation: |
      #!/bin/bash
      LOG="/var/www/html/data/conduction-apps.log"
      
      log() {
        echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOG" 2>&1
      }
      
      log "=== Conduction Apps Post-Install Hook Started ==="
      
      install_app() {
        APP_NAME=$1
        VERSION_VAR=$2
        
        VERSION=$(eval echo "\$$VERSION_VAR")
        
        if [ -n "$VERSION" ]; then
          # PINNED VERSION: Download from GitHub releases
          log "Installing $APP_NAME v$VERSION (pinned)..."
          
          # Remove bundled version from /apps/ if exists (takes precedence otherwise!)
          if [ -d "/var/www/html/apps/$APP_NAME" ]; then
            log "Removing bundled $APP_NAME from /apps/ to use pinned version"
            rm -rf "/var/www/html/apps/$APP_NAME"
          fi
          
          # Download pinned version to custom_apps
          URL="https://github.com/ConductionNL/$APP_NAME/releases/download/v$VERSION/$APP_NAME-$VERSION.tar.gz"
          log "Download URL: $URL"
          mkdir -p /var/www/html/custom_apps
          
          if curl -fsSL "$URL" -o /tmp/$APP_NAME.tar.gz 2>>"$LOG"; then
            rm -rf "/var/www/html/custom_apps/$APP_NAME" 2>/dev/null
            tar -xzf /tmp/$APP_NAME.tar.gz -C /var/www/html/custom_apps/ 2>>"$LOG"
            rm /tmp/$APP_NAME.tar.gz
            chown -R www-data:www-data "/var/www/html/custom_apps/$APP_NAME"
            log "$APP_NAME v$VERSION installed from GitHub to custom_apps"
          else
            log "ERROR: GitHub download failed for $URL"
            return 1
          fi
        else
          # LATEST: Install from app store (only if not already installed)
          if php occ app:list 2>/dev/null | grep -q "- $APP_NAME:"; then
            log "$APP_NAME already installed (latest)"
            return 0
          fi
          log "Installing $APP_NAME (latest from app store)..."
          php occ app:install "$APP_NAME" 2>>"$LOG" || true
        fi
        
        php occ app:enable "$APP_NAME" 2>>"$LOG" || true
        
        # After enable: remove /apps/ version if we installed a pinned version
        # (app:enable might download to /apps/ which takes precedence over custom_apps)
        if [ -n "$VERSION" ] && [ -d "/var/www/html/apps/$APP_NAME" ]; then
          log "Removing /apps/$APP_NAME (app:enable downloaded it, but we want custom_apps version)"
          rm -rf "/var/www/html/apps/$APP_NAME"
          # Re-enable to pick up from custom_apps
          php occ app:enable "$APP_NAME" 2>>"$LOG" || true
        fi
        
        INSTALLED_VER=$(php occ app:list 2>/dev/null | grep "- $APP_NAME:" | sed 's/.*: //')
        log "$APP_NAME enabled (version: $INSTALLED_VER)"
      }
      
      install_app "opencatalogi"  "OPENCATALOGI_VERSION"
      install_app "openconnector" "OPENCONNECTOR_VERSION"
      install_app "openregister"  "OPENREGISTER_VERSION"
      
      log "=== Conduction Apps Post-Install Hook Complete ==="
    post-upgrade: |
      #!/bin/bash
      echo "$(date '+%Y-%m-%d %H:%M:%S') Post-upgrade hook completed" >> /var/www/html/data/conduction-apps.log

# =============================================================================
# INGRESS
# =============================================================================
ingress:
  tls:
    - secretName: nextcloud-canary-pg-tls
      hosts:
        - nextcloud-canary-pg.commonground.nu
  hosts:
    - host: nextcloud-canary-pg.commonground.nu
      paths:
        - path: /
          pathType: Prefix

# =============================================================================
# RESOURCES
# =============================================================================
resources:
  requests:
    cpu: 250m
    memory: 512Mi
  limits:
    cpu: 2
    memory: 2Gi

replicaCount: 1

hpa:
  enabled: false

# =============================================================================
# LABELS
# =============================================================================
podLabels:
  nextcloud.platform/tenant: canary-pg
  nextcloud.platform/wave: "1"
  nextcloud.platform/database: postgresql


