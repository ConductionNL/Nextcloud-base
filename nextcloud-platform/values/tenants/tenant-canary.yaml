---
# Canary tenant configuration
# This tenant is ALWAYS upgraded first (wave 0)
# Production environment

tenant:
  name: canary
  environment: prod
  wave: "0"
  hostname: nextcloud-canary.commonground.nu
  
  s3:
    bucket: nextcloud
    prefix: ""

# =============================================================================
# DATABASE: MariaDB (in-cluster)
# =============================================================================
mariadb:
  enabled: true
  image:
    registry: docker.io
    repository: bitnamilegacy/mariadb
    tag: "11.2"
  auth:
    database: nextcloud
    username: nextcloud
    existingSecret: nextcloud-secrets
    secretKeys:
      mariadb-root-password: mariadb-root-password
      mariadb-password: mariadb-password
  primary:
    persistence:
      enabled: true
      size: 8Gi

# Disable internal SQLite
internalDatabase:
  enabled: false

# Disable external PostgreSQL (using MariaDB subchart instead)
externalDatabase:
  enabled: false
  existingSecret:
    enabled: false

# =============================================================================
# NEXTCLOUD SETTINGS
# =============================================================================
nextcloud:
  host: nextcloud-canary.commonground.nu
  
  trustedDomains:
    - nextcloud-canary.commonground.nu
  
  # Pod security context - www-data is UID/GID 33 in official Nextcloud image
  podSecurityContext:
    fsGroup: 33
    fsGroupChangePolicy: "OnRootMismatch"

# =============================================================================
# INGRESS
# =============================================================================
ingress:
  tls:
    - secretName: nextcloud-canary-tls
      hosts:
        - nextcloud-canary.commonground.nu
  hosts:
    - host: nextcloud-canary.commonground.nu
      paths:
        - path: /
          pathType: Prefix

# =============================================================================
# RESOURCES
# =============================================================================
resources:
  requests:
    cpu: 250m
    memory: 512Mi
  limits:
    cpu: 2
    memory: 2Gi

replicaCount: 1

hpa:
  enabled: false

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================
extraEnv:
  - name: PHP_MEMORY_LIMIT
    value: "2048M"
  - name: PHP_UPLOAD_LIMIT
    value: "16G"
  - name: S3_ACCESS_KEY
    valueFrom:
      secretKeyRef:
        name: nextcloud-secrets
        key: s3-access-key
  - name: S3_SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: nextcloud-secrets
        key: s3-secret-key
  # ---------------------------------------------------------------------------
  # APP VERSION PINNING (optioneel)
  # ---------------------------------------------------------------------------
  # Uncomment om specifieke versies te pinnen
  - name: OPENCATALOGI_VERSION
    value: "0.7.6
  - name: OPENCONNECTOR_VERSION
    value: "0.2.6
  - name: OPENREGISTER_VERSION
    value: "0.2.8"

# =============================================================================
# LABELS
# =============================================================================
podLabels:
  nextcloud.platform/tenant: canary
  nextcloud.platform/wave: "0"
  nextcloud.platform/role: canary

# =============================================================================
# CONDUCTION APPS INSTALLER
# =============================================================================
# Draait in BACKGROUND om container startup niet te blokkeren
# Logs: /var/www/html/data/conduction-apps.log
# =============================================================================

lifecycle:
  postStartCommand:
    - /bin/sh
    - -c
    - |
      # Run in background to not block container startup
      (
        LOG="/var/www/html/data/conduction-apps.log"
        
        log() {
          echo "$(date '+%Y-%m-%d %H:%M:%S') $1" >> "$LOG" 2>&1
        }
        
        log "=== Conduction Apps Installer Started (background) ==="
        
        # Wacht tot Nextcloud klaar is (max 10 minuten)
        TIMEOUT=600
        ELAPSED=0
        until php occ status 2>/dev/null | grep -q "installed: true"; do
          if [ $ELAPSED -ge $TIMEOUT ]; then
            log "ERROR: Timeout waiting for Nextcloud"
            exit 1
          fi
          log "Waiting for Nextcloud to be ready... ($ELAPSED/$TIMEOUT sec)"
          sleep 15
          ELAPSED=$((ELAPSED + 15))
        done
        
        log "Nextcloud is ready, installing apps..."
        
        install_app() {
          APP_NAME=$1
          VERSION_VAR=$2
          
          if php occ app:list 2>/dev/null | grep -q "- $APP_NAME:"; then
            log "$APP_NAME already installed"
            return 0
          fi
          
          VERSION=$(eval echo "\$$VERSION_VAR")
          
          if [ -n "$VERSION" ]; then
            log "Installing $APP_NAME v$VERSION (pinned)..."
            URL="https://github.com/ConductionNL/$APP_NAME/releases/download/v$VERSION/$APP_NAME-$VERSION.tar.gz"
            mkdir -p /var/www/html/custom_apps
            if curl -fsSL "$URL" -o /tmp/$APP_NAME.tar.gz 2>>"$LOG"; then
              tar -xzf /tmp/$APP_NAME.tar.gz -C /var/www/html/custom_apps/ 2>>"$LOG"
              rm /tmp/$APP_NAME.tar.gz
              log "$APP_NAME v$VERSION installed from GitHub"
            else
              log "WARNING: GitHub download failed, trying app store..."
              php occ app:install "$APP_NAME" 2>>"$LOG" || true
            fi
          else
            log "Installing $APP_NAME (latest)..."
            php occ app:install "$APP_NAME" 2>>"$LOG" || true
          fi
          
          php occ app:enable "$APP_NAME" 2>>"$LOG" || true
          log "$APP_NAME enabled"
        }
        
        install_app "opencatalogi"  "OPENCATALOGI_VERSION"
        install_app "openconnector" "OPENCONNECTOR_VERSION"
        install_app "openregister"  "OPENREGISTER_VERSION"
        
        log "=== Conduction Apps Installer Complete ==="
      ) &

