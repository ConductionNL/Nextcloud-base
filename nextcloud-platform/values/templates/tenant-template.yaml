---
# TEMPLATE - Copy this file to values/tenants/tenant-<name>.yaml
# This file is NOT deployed, it's just a template
#
# Vervang overal:
#   <TENANT_NAME>  ->  je tenant naam (bijv. "acme")
#   <NAME>         ->  hostname prefix (bijv. "acme" voor acme.nextcloud.commonground.nu)

tenant:
  name: <TENANT_NAME>           # e.g., "acme"
  environment: prod             # accept or prod
  wave: "1"                     # 0=canary, 1+=production waves
  hostname: <NAME>.nextcloud.commonground.nu
  
  s3:
    bucket: nextcloud           # Shared bucket
    prefix: "<TENANT_NAME>/"    # Prefix to isolate data

# =============================================================================
# DATABASE: MariaDB (in-cluster)
# =============================================================================
mariadb:
  enabled: true
  image:
    registry: docker.io
    repository: bitnamilegacy/mariadb
    tag: "11.2"
  auth:
    database: nextcloud
    username: nextcloud
    existingSecret: nextcloud-secrets
    secretKeys:
      mariadb-root-password: mariadb-root-password
      mariadb-password: mariadb-password
  primary:
    persistence:
      enabled: true
      size: 8Gi

# Disable internal SQLite
internalDatabase:
  enabled: false

# Disable external PostgreSQL (using MariaDB subchart instead)
externalDatabase:
  enabled: false
  existingSecret:
    enabled: false

# =============================================================================
# NEXTCLOUD SETTINGS
# =============================================================================
nextcloud:
  host: <NAME>.nextcloud.commonground.nu
  
  trustedDomains:
    - <NAME>.nextcloud.commonground.nu
  
  # Pod security context - www-data is UID/GID 33 in official Nextcloud image
  podSecurityContext:
    fsGroup: 33
    fsGroupChangePolicy: "OnRootMismatch"

# =============================================================================
# INGRESS
# =============================================================================
ingress:
  tls:
    - secretName: nextcloud-<TENANT_NAME>-tls
      hosts:
        - <NAME>.nextcloud.commonground.nu
  hosts:
    - host: <NAME>.nextcloud.commonground.nu
      paths:
        - path: /
          pathType: Prefix

# =============================================================================
# RESOURCES
# =============================================================================
resources:
  requests:
    cpu: 250m
    memory: 512Mi
  limits:
    cpu: 2
    memory: 2Gi

replicaCount: 1

hpa:
  enabled: false

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================
extraEnv:
  - name: PHP_MEMORY_LIMIT
    value: "2048M"
  - name: PHP_UPLOAD_LIMIT
    value: "16G"
  # S3 credentials
  - name: S3_ACCESS_KEY
    valueFrom:
      secretKeyRef:
        name: nextcloud-secrets
        key: s3-access-key
  - name: S3_SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: nextcloud-secrets
        key: s3-secret-key
  # ---------------------------------------------------------------------------
  # APP VERSION PINNING (optioneel)
  # ---------------------------------------------------------------------------
  # Uncomment om specifieke versies te pinnen in plaats van latest
  # Als niet gezet: app store latest wordt gebruikt
  #
  # Format: versie zonder 'v' prefix
  #   Stable:  "1.2.3"
  #   Beta:    "0.2.10-beta.9"
  #
  # Download URL wordt: 
  #   https://github.com/ConductionNL/{app}/releases/download/v{VERSION}/{app}-{VERSION}.tar.gz
  #
  # - name: OPENCATALOGI_VERSION
  #   value: "1.2.3"
  # - name: OPENCONNECTOR_VERSION
  #   value: "2.0.1"
  # - name: OPENREGISTER_VERSION
  #   value: "0.2.10-beta.9"

# =============================================================================
# LABELS
# =============================================================================
podLabels:
  nextcloud.platform/tenant: <TENANT_NAME>
  nextcloud.platform/wave: "1"

# =============================================================================
# CONDUCTION APPS INSTALLER
# =============================================================================
# Installeert automatisch de Conduction product apps:
#   - opencatalogi   : Open Catalogi - publicatie platform
#   - openconnector  : Open Connector - integratie platform
#   - openregister   : Open Register - register beheer
#
# Versie gedrag:
#   - Geen *_VERSION env var: latest uit app store (default)
#   - Met *_VERSION env var: download specifieke versie van GitHub
#
# Apps worden geïnstalleerd bij pod start (idempotent)
# =============================================================================

lifecycle:
  postStartCommand:
    - /bin/sh
    - -c
    - |
      echo "=== Conduction Apps Installer ===" 
      
      # Wacht tot Nextcloud klaar is
      until php occ status 2>/dev/null | grep -q "installed: true"; do
        echo "Waiting for Nextcloud to be ready..."
        sleep 10
      done
      
      echo "Nextcloud is ready, checking apps..."
      
      # Functie: installeer app (latest of pinned version)
      install_app() {
        APP_NAME=$1
        VERSION_VAR=$2
        GITHUB_ORG=${3:-"ConductionNL"}
        
        # Check of app al geïnstalleerd is
        if php occ app:list 2>/dev/null | grep -q "- $APP_NAME:"; then
          echo "$APP_NAME already installed, skipping"
          return 0
        fi
        
        # Haal versie op uit environment (indien gezet)
        VERSION=$(eval echo "\$$VERSION_VAR")
        
        if [ -n "$VERSION" ]; then
          # Pinned version: download van GitHub
          # URL format: {app}-{version}.tar.gz (werkt voor stable en beta)
          echo "Installing $APP_NAME v$VERSION (pinned)..."
          URL="https://github.com/$GITHUB_ORG/$APP_NAME/releases/download/v$VERSION/$APP_NAME-$VERSION.tar.gz"
          
          mkdir -p /var/www/html/custom_apps
          if curl -fsSL "$URL" -o /tmp/$APP_NAME.tar.gz; then
            tar -xzf /tmp/$APP_NAME.tar.gz -C /var/www/html/custom_apps/
            rm /tmp/$APP_NAME.tar.gz
            echo "$APP_NAME v$VERSION installed from GitHub"
          else
            echo "Warning: Failed to download $APP_NAME v$VERSION, trying app store..."
            php occ app:install "$APP_NAME" || echo "Warning: Could not install $APP_NAME"
          fi
        else
          # No version pinned: use app store (latest)
          echo "Installing $APP_NAME (latest from app store)..."
          php occ app:install "$APP_NAME" || echo "Warning: Could not install $APP_NAME"
        fi
        
        # Enable app
        php occ app:enable "$APP_NAME" 2>/dev/null || true
      }
      
      # Installeer Conduction apps
      # Args: app_name, version_env_var, github_org (optional)
      install_app "opencatalogi"  "OPENCATALOGI_VERSION"
      install_app "openconnector" "OPENCONNECTOR_VERSION"
      install_app "openregister"  "OPENREGISTER_VERSION"
      
      echo "=== Conduction Apps Installer Complete ==="
