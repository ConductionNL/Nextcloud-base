---
# TEMPLATE - Copy this file to values/tenants/tenant-<name>.yaml
# This file is NOT deployed, it's just a template

tenant:
  name: <TENANT_NAME>           # e.g., "acme"
  environment: prod             # accept or prod
  wave: "1"                     # 0=canary, 1+=production waves
  hostname: <NAME>.nextcloud.commonground.nu
  
  s3:
    bucket: nextcloud           # Shared bucket
    prefix: "<TENANT_NAME>/"    # Prefix to isolate data

# =============================================================================
# CONDUCTION APPS
# =============================================================================
# De Conduction product apps die automatisch geïnstalleerd worden
# Deze apps vormen het product dat we uitleveren
#
# Apps:
#   - opencatalogi   : Open Catalogi - publicatie platform
#   - openconnector  : Open Connector - integratie platform  
#   - openregister   : Open Register - register beheer
#
# Installatie gebeurt via post-install hook bij eerste deployment
# =============================================================================

# Database: MariaDB (in-cluster)
mariadb:
  enabled: true
  image:
    registry: docker.io
    repository: bitnami/mariadb
    tag: "11.2"
  auth:
    database: nextcloud
    username: nextcloud
    existingSecret: nextcloud-secrets
    secretKeys:
      password: db-password
  primary:
    persistence:
      enabled: true
      size: 8Gi

internalDatabase:
  enabled: false

externalDatabase:
  enabled: false

# Nextcloud settings
nextcloud:
  host: <NAME>.nextcloud.commonground.nu
  
  trustedDomains:
    - <NAME>.nextcloud.commonground.nu
  
  # Conduction Apps - geïnstalleerd bij eerste boot
  configs:
    conduction-apps.config.php: |
      <?php
      // Conduction Product Apps
      // Deze config zorgt dat de apps worden ingeschakeld
      $CONFIG = array (
        // Apps die standaard enabled moeten zijn na installatie
        // De daadwerkelijke installatie gebeurt via de hook
        'default_phone_region' => 'NL',
      );
    
    s3.config.php: |
      <?php
      $CONFIG = array (
        'objectstore' => array(
          'class' => '\OC\Files\ObjectStore\S3',
          'arguments' => array(
            'bucket' => 'nextcloud',
            'hostname' => 'core.fuga.cloud',
            'port' => 8080,
            'use_ssl' => true,
            'verify_ssl_cert' => true,
            'region' => '',
            'use_path_style' => true,
            'key' => getenv('S3_ACCESS_KEY'),
            'secret' => getenv('S3_SECRET_KEY'),
            'objectPrefix' => '<TENANT_NAME>/urn:oid:',
            'autocreate' => false,
          ),
        ),
      );

# Ingress
ingress:
  tls:
    - secretName: nextcloud-<TENANT_NAME>-tls
      hosts:
        - <NAME>.nextcloud.commonground.nu
  hosts:
    - host: <NAME>.nextcloud.commonground.nu
      paths:
        - path: /
          pathType: Prefix

# Resources
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 4
    memory: 4Gi

# S3 credentials
extraEnv:
  - name: PHP_MEMORY_LIMIT
    value: "2048M"
  - name: PHP_UPLOAD_LIMIT
    value: "16G"
  - name: S3_ACCESS_KEY
    valueFrom:
      secretKeyRef:
        name: nextcloud-secrets
        key: s3-access-key
  - name: S3_SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: nextcloud-secrets
        key: s3-secret-key

# Labels
podLabels:
  nextcloud.platform/tenant: <TENANT_NAME>
  nextcloud.platform/wave: "1"

# =============================================================================
# CONDUCTION APPS INSTALLER
# =============================================================================
# Lifecycle hook die de Conduction apps installeert na pod start
# Apps worden alleen geïnstalleerd als ze nog niet bestaan
#
# Voeg meer apps toe aan de lijst indien nodig
# =============================================================================

lifecycle:
  postStartCommand:
    - /bin/sh
    - -c
    - |
      echo "=== Conduction Apps Installer ===" 
      
      # Wacht tot Nextcloud klaar is
      until php occ status 2>/dev/null | grep -q "installed: true"; do
        echo "Waiting for Nextcloud to be ready..."
        sleep 10
      done
      
      echo "Nextcloud is ready, checking apps..."
      
      # Conduction Apps lijst
      APPS="opencatalogi openconnector openregister"
      
      for APP in $APPS; do
        if ! php occ app:list | grep -q "- $APP:"; then
          echo "Installing $APP..."
          php occ app:install "$APP" || echo "Warning: Could not install $APP (may not exist in app store yet)"
        else
          echo "$APP already installed"
        fi
        
        # Enable app (idempotent)
        php occ app:enable "$APP" 2>/dev/null || true
      done
      
      echo "=== Conduction Apps Installer Complete ==="

