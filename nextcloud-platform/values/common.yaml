---
# Common values for all Nextcloud tenants
# This file is merged with env/*.yaml and tenants/*.yaml

# Helm chart configuration
chart:
  # Pin the Nextcloud Helm chart version for reproducibility
  # Update this to upgrade all tenants
  version: "8.8.1"

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================
# Choose ONE of three options by setting database.type:
#   - "mariadb"   : In-cluster MariaDB per tenant (simplest, default)
#   - "postgres"  : In-cluster PostgreSQL per tenant  
#   - "external"  : External PostgreSQL with PgBouncer (production)
#
# Override in env/*.yaml or tenant values
# =============================================================================

database:
  # Options: mariadb, postgres, external
  type: mariadb

# -----------------------------------------------------------------------------
# Option 1: MariaDB (default, simplest)
# -----------------------------------------------------------------------------
# Each tenant gets their own MariaDB pod
# Good for: getting started, development, small deployments
# Drawback: less resilient during node upgrades (but data in PVC survives)

mariadb:
  enabled: true  # Set to false if using postgres or external
  auth:
    database: nextcloud
    username: nextcloud
    # Password from existingSecret
  primary:
    persistence:
      enabled: true
      size: 8Gi
      storageClass: ""  # Use default, or set to cephfs
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

# -----------------------------------------------------------------------------
# Option 2: PostgreSQL in-cluster
# -----------------------------------------------------------------------------
# Each tenant gets their own PostgreSQL pod
# Good for: PostgreSQL features, slightly better performance
# Drawback: same resilience concerns as MariaDB

postgresql:
  enabled: false  # Set to true for in-cluster PostgreSQL
  auth:
    database: nextcloud
    username: nextcloud
    # Password from existingSecret
  primary:
    persistence:
      enabled: true
      size: 8Gi
      storageClass: ""
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

# -----------------------------------------------------------------------------
# Option 3: External PostgreSQL (production recommended)
# -----------------------------------------------------------------------------
# Shared external PostgreSQL with PgBouncer connection pooling
# Good for: production, multi-tenant efficiency, managed databases
# Requires: postgres-admin secret for auto-provisioning

internalDatabase:
  enabled: false

externalDatabase:
  enabled: false  # Set to true for external PostgreSQL
  type: postgresql
  host: pgbouncer.nextcloud-platform.svc.cluster.local
  port: 5432
  # database: nextcloud_<tenant>  # Set per tenant
  existingSecret:
    enabled: true
    secretName: nextcloud-secrets
    usernameKey: db-username
    passwordKey: db-password

# =============================================================================
# END DATABASE CONFIGURATION
# =============================================================================

# Global image settings
image:
  repository: nextcloud
  tag: "32.0.5-fpm"
  pullPolicy: Always

# Replica count (can be overridden per env/tenant)
replicaCount: 1

# Nextcloud configuration
nextcloud:
  # Host is set per-tenant
  # host: tenant.example.com
  
  # Pod security context - www-data is UID/GID 33 in official Nextcloud image
  podSecurityContext:
    fsGroup: 33
    fsGroupChangePolicy: "OnRootMismatch"
  
  # Existing secret for credentials (created by ExternalSecret)
  existingSecret:
    enabled: true
    secretName: nextcloud-secrets
    usernameKey: nextcloud-username
    passwordKey: nextcloud-password
    smtpUsernameKey: smtp-username
    smtpPasswordKey: smtp-password
    smtpHostKey: smtp-host
  
  # Update strategy
  update: 0
  
  # Data directory (inside container)
  datadir: /var/www/html/data
  
  # PHP configuration
  phpConfigs:
    www.conf: |
      [www]
      user = www-data
      group = www-data
      listen = 127.0.0.1:9000
      
      pm = dynamic
      pm.max_children = 50
      pm.start_servers = 5
      pm.min_spare_servers = 5
      pm.max_spare_servers = 35
      pm.max_requests = 500
      
      ; PHP settings
      php_admin_value[memory_limit] = 2048M
      php_admin_value[upload_max_filesize] = 16G
      php_admin_value[post_max_size] = 16G
      php_admin_value[max_execution_time] = 3600
      php_admin_value[max_input_time] = 3600
      php_admin_value[output_buffering] = Off
  
  # DISABLE ALL default configs - let Nextcloud manage config.php itself
  # These mount as read-only ConfigMaps and block Nextcloud from writing!
  defaultConfigs:
    .htaccess: false
    redis.config.php: false
    apache-pretty-urls.config.php: false
    apcu.config.php: false
    apps.config.php: false
    autoconfig.php: false
    smtp.config.php: false
    logging.config.php: false
  
  # Custom Nextcloud configs
  configs:
    proxy.config.php: |
      <?php
      $CONFIG = array (
        // Trust proxies in cluster network ranges
        'trusted_proxies' => array(
          0 => '127.0.0.1',
          1 => '100.96.0.0/16',   // Kubernetes pod network
          2 => '10.0.0.0/8',       // Internal services
          3 => '192.168.0.0/16',   // Private networks
        ),
        'forwarded_for_headers' => array('HTTP_X_FORWARDED_FOR'),
        'overwriteprotocol' => 'https',
        
        // Session settings
        'session_lifetime' => 28800,      // 8 hours
        'session_idle_timeout' => 7200,   // 2 hours idle
        'session_keepalive' => false,
        
        // UI settings
        'simpleSignUpLink.shown' => false,
        
        // Cleanup settings
        'trashbin_retention_obligation' => 'auto',
        'activity_expire_days' => 2,
      );

# Nginx configuration (sidecar)
nginx:
  enabled: true
  image:
    repository: nginx
    tag: "alpine"
    pullPolicy: IfNotPresent
  
  config:
    default: |
      upstream php-handler {
          server 127.0.0.1:9000;
      }
      
      server {
          listen 8080;
          
          add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload" always;
          
          client_max_body_size 16G;
          client_body_timeout 1800s;
          fastcgi_buffers 64 4K;
          fastcgi_read_timeout 1800s;
          fastcgi_send_timeout 1800s;
          proxy_read_timeout 1800s;
          proxy_send_timeout 1800s;
          send_timeout 1800s;
          
          gzip on;
          gzip_vary on;
          gzip_comp_level 4;
          gzip_min_length 256;
          gzip_proxied expired no-cache no-store private no_last_modified no_etag auth;
          gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/wasm application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy;
          
          root /var/www/html;
          
          add_header Referrer-Policy "no-referrer" always;
          add_header X-Content-Type-Options "nosniff" always;
          add_header X-Download-Options "noopen" always;
          add_header X-Frame-Options "SAMEORIGIN" always;
          add_header X-Permitted-Cross-Domain-Policies "none" always;
          add_header X-Robots-Tag "noindex, nofollow" always;
          add_header X-XSS-Protection "1; mode=block" always;
          
          fastcgi_hide_header X-Powered-By;
          
          location = /robots.txt {
              allow all;
              log_not_found off;
              access_log off;
          }
          
          location ^~ /.well-known {
              location = /.well-known/carddav { return 301 /remote.php/dav/; }
              location = /.well-known/caldav  { return 301 /remote.php/dav/; }
              location /.well-known/acme-challenge { try_files $uri $uri/ =404; }
              location /.well-known/pki-validation { try_files $uri $uri/ =404; }
              return 301 /index.php$request_uri;
          }
          
          location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)(?:$|/) { return 404; }
          location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console) { return 404; }
          
          location ~ \.php(?:$|/) {
              rewrite ^/(?!index|remote|public|cron|core\/ajax\/update|status|ocs\/v[12]|updater\/.+|oc[ms]-provider\/.+|.+\/richdocumentscode\/proxy) /index.php$request_uri;
              
              fastcgi_split_path_info ^(.+?\.php)(/.*)$;
              set $path_info $fastcgi_path_info;
              
              try_files $fastcgi_script_name =404;
              
              include fastcgi_params;
              fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              fastcgi_param PATH_INFO $path_info;
              fastcgi_param HTTPS on;
              fastcgi_param modHeadersAvailable true;
              fastcgi_param front_controller_active true;
              
              fastcgi_pass php-handler;
              fastcgi_intercept_errors on;
              fastcgi_request_buffering off;
          }
          
          location ~ \.(?:css|js|svg|gif|png|jpg|ico|wasm|tflite|map)$ {
              try_files $uri /index.php$request_uri;
              add_header Cache-Control "public, max-age=15778463";
              access_log off;
          }
          
          location ~ \.woff2?$ {
              try_files $uri /index.php$request_uri;
              expires 7d;
              access_log off;
          }
          
          location /remote {
              return 301 /remote.php$request_uri;
          }
          
          location / {
              try_files $uri $uri/ /index.php$request_uri;
          }
      }

# Ingress configuration
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/proxy-body-size: "16G"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "1800"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "1800"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "1800"
    nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
    # NOTE: Removed server-snippet for caldav/carddav - caused duplicate location errors
    # Nextcloud handles these redirects internally
  tls:
    - secretName: nextcloud-tls
      hosts: []

# Service configuration
service:
  type: ClusterIP
  port: 8080
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
    prometheus.io/path: "/metrics"

# Persistence configuration
persistence:
  enabled: true
  accessMode: ReadWriteOnce
  size: 20Gi
  storageClass: ""
  
  nextcloudData:
    enabled: false  # Data goes to S3

# Cron job
cronjob:
  enabled: true
  schedule: "*/5 * * * *"
  annotations:
    prometheus.io/scrape: "false"
  failedJobsHistoryLimit: 3
  successfulJobsHistoryLimit: 3

# Probes
livenessProbe:
  enabled: true
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 6
  successThreshold: 1

readinessProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 15
  timeoutSeconds: 10
  failureThreshold: 3
  successThreshold: 1

startupProbe:
  enabled: true
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 10
  failureThreshold: 60
  successThreshold: 1

# Resources
resources:
  requests:
    cpu: 250m
    memory: 512Mi
  limits:
    cpu: 2
    memory: 2Gi

# Pod annotations
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9090"
  prometheus.io/path: "/metrics"

# Don't set deprecated top-level securityContext
# The correct key is nextcloud.podSecurityContext (set in nextcloud section above)

# Node selector
nodeSelector:
  kubernetes.io/os: linux

# Affinity
affinity: {}

# Tolerations
tolerations: []

# HPA
hpa:
  enabled: false
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# Metrics
metrics:
  enabled: false

# Redis (external - platform service)
redis:
  enabled: false

# Extra environment variables
extraEnv:
  - name: PHP_MEMORY_LIMIT
    value: "2048M"
  - name: PHP_UPLOAD_LIMIT
    value: "16G"
  - name: NEXTCLOUD_INIT_HTACCESS
    value: "true"
  - name: NC_default_phone_region
    value: "NL"

# Extra volumes
extraVolumes:
  - name: nextcloud-logs
    emptyDir: {}

extraVolumeMounts:
  - name: nextcloud-logs
    mountPath: /var/log/nextcloud
